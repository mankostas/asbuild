openapi: 3.0.3
info:
  title: Asbuild API
  version: '1.0'
paths:
  /tasks:
    get:
      summary: List tasks
      parameters:
        - name: type
          in: query
          schema:
            type: integer
        - name: status
          in: query
          schema:
            type: string
        - name: assignee
          in: query
          schema:
            type: integer
        - name: priority
          in: query
          schema:
            type: integer
        - name: due_from
          in: query
          schema:
            type: string
            format: date
        - name: due_to
          in: query
          schema:
            type: string
            format: date
        - name: has_photos
          in: query
          schema:
            type: boolean
        - name: mine
          in: query
          schema:
            type: boolean
        - name: sort
          in: query
          schema:
            type: string
            enum: [created_at, due_at, priority, board_position]
        - name: dir
          in: query
          schema:
            type: string
            enum: [asc, desc]
      responses:
        '200':
          description: List of tasks
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Task'
                  meta:
                    type: object
                    properties:
                      page:
                        type: integer
                      per_page:
                        type: integer
                      total:
                        type: integer
                      last_page:
                        type: integer
    post:
      summary: Create task
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Task'
      responses:
        '200':
          description: Task created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
  /tasks/{task}:
    patch:
      summary: Update task
      parameters:
        - name: task
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Task'
      responses:
        '200':
          description: Updated task
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
  /tasks/{task}/status:
    post:
      summary: Update task status
      parameters:
        - name: task
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
      responses:
        '200':
          description: Updated task
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '422':
          description: Invalid transition
  /tasks/{task}/watch:
    post:
      summary: Watch task
      parameters:
        - name: task
          in: path
          required: true
          schema:
            type: integer
      responses:
        '201':
          description: Watching task
    delete:
      summary: Unwatch task
      parameters:
        - name: task
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Not watching
  /tasks/{task}/subtasks:
    post:
      summary: Create task subtask
      parameters:
        - name: task
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskSubtask'
      responses:
        '201':
          description: Created subtask
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskSubtask'
  /tasks/{task}/subtasks/{subtask}:
    patch:
      summary: Update task subtask
      parameters:
        - name: task
          in: path
          required: true
          schema:
            type: integer
        - name: subtask
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskSubtask'
      responses:
        '200':
          description: Updated subtask
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskSubtask'
    delete:
      summary: Delete task subtask
      parameters:
        - name: task
          in: path
          required: true
          schema:
            type: integer
        - name: subtask
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Deleted
  /tasks/{task}/subtasks/reorder:
    patch:
      summary: Reorder subtasks
      parameters:
        - name: task
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                order:
                  type: array
                  items:
                    type: integer
      responses:
        '200':
          description: Reordered
  /tasks/{task}/comments:
    get:
      summary: List task comments
      parameters:
        - name: task
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: List of comments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TaskComment'
    post:
      summary: Create task comment
      parameters:
        - name: task
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                body:
                  type: string
                mentions:
                  type: array
                  items:
                    type: integer
                files:
                  type: array
                  items:
                    type: integer
      responses:
        '201':
          description: Created comment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskComment'
  /roles:
    get:
      summary: List roles
      parameters:
        - name: scope
          in: query
          schema:
            type: string
        - name: tenant_id
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: List of roles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Role'
    post:
      summary: Create role
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Role'
      responses:
        '200':
          description: Role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
  /roles/{id}:
    patch:
      summary: Update role
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Role'
      responses:
        '200':
          description: Updated role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
    delete:
      summary: Delete role
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Deleted
  /uploads/{uploadId}/finalize:
    post:
      summary: Finalize upload
      parameters:
        - name: uploadId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - filename
                - task_id
                - field_key
                - section_key
              properties:
                filename:
                  type: string
                task_id:
                  type: integer
                field_key:
                  type: string
                section_key:
                  type: string
      responses:
        '200':
          description: Uploaded file info
          content:
            application/json:
              schema:
                type: object
                properties:
                  file_id:
                    type: integer
                  name:
                    type: string
                  variants:
                    type: object
  /roles/{roleId}/assign:
    post:
      summary: Assign user to role
      parameters:
        - name: roleId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleAssignment'
      responses:
        '200':
          description: Role assignment response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
  /teams:
    get:
      summary: List teams
      responses:
        '200':
          description: List of teams
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Team'
    post:
      summary: Create team
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Team'
      responses:
        '200':
          description: Team
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Team'
  /teams/{id}:
    patch:
      summary: Update team
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Team'
      responses:
        '200':
          description: Team
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Team'
    delete:
      summary: Delete team
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Deleted
  /teams/{teamId}/employees:
    post:
      summary: Sync team employees
      parameters:
        - name: teamId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                employee_ids:
                  type: array
                  items:
                    type: integer
      responses:
        '200':
          description: Team with employees
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Team'
  /task-types:
    get:
      summary: List task types
      parameters:
        - name: scope
          in: query
          schema:
            type: string
        - name: tenant_id
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of types
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TaskType'
  /task-types/{id}/copy-to-tenant:
    post:
      summary: Copy task type to tenant
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                tenant_id:
                  type: string
      responses:
        '200':
          description: Task type
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskType'
  /task-types/{id}/export:
    post:
      summary: Export task type
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Task type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskType'
  /task-types/import:
    post:
      summary: Import task type
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskType'
      responses:
        '201':
          description: Task type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskType'
  /task-types/validate:
    post:
      summary: Validate task type schema and data
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - schema_json
              properties:
                schema_json:
                  type: object
                form_data:
                  type: object
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '422':
          description: Validation errors
  /task-types/{id}/validate:
    post:
      summary: Validate task type schema and data
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                schema_json:
                  type: object
                form_data:
                  type: object
      responses:
        '200':
          description: OK
        '422':
          description: Validation errors

  /task-types/{task_type}/sla-policies:
    get:
      summary: List SLA policies
      parameters:
        - name: task_type
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Policies
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/TaskSlaPolicy'
    post:
      summary: Create SLA policy
      parameters:
        - name: task_type
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskSlaPolicy'
      responses:
        '201':
          description: Policy
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/TaskSlaPolicy'

  /task-types/{task_type}/sla-policies/{id}:
    put:
      summary: Update SLA policy
      parameters:
        - name: task_type
          in: path
          required: true
          schema:
            type: integer
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskSlaPolicy'
      responses:
        '200':
          description: Policy
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/TaskSlaPolicy'
    delete:
      summary: Delete SLA policy
      parameters:
        - name: task_type
          in: path
          required: true
          schema:
            type: integer
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /task-types/{task_type}/automations:
    get:
      summary: List automations
      parameters:
        - name: task_type
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Automations
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/TaskAutomation'
    post:
      summary: Create automation
      parameters:
        - name: task_type
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskAutomation'
      responses:
        '201':
          description: Automation
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/TaskAutomation'

  /task-types/{task_type}/automations/{id}:
    put:
      summary: Update automation
      parameters:
        - name: task_type
          in: path
          required: true
          schema:
            type: integer
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskAutomation'
      responses:
        '200':
          description: Automation
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/TaskAutomation'
    delete:
      summary: Delete automation
      parameters:
        - name: task_type
          in: path
          required: true
          schema:
            type: integer
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
  /task-statuses:
    get:
      summary: List task statuses
      parameters:
        - name: scope
          in: query
          schema:
            type: string
        - name: tenant_id
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: List of task statuses
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/TaskStatus'
                  meta:
                    type: object
                    properties:
                      page:
                        type: integer
                      per_page:
                        type: integer
                      total:
                        type: integer
                      last_page:
                        type: integer
  /task-statuses/{id}/copy-to-tenant:
    post:
      summary: Copy status to tenant
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                tenant_id:
                  type: string
      responses:
        '200':
          description: Status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskStatus'
  /notifications:
    get:
      summary: List notifications
      responses:
        '200':
          description: List of notifications
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Notification'
  /notifications/{id}/read:
    post:
      summary: Mark notification read
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Marked read

  /task-board:
    get:
      summary: Get tasks grouped by status
      parameters:
        - name: type_id
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Board columns
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        status:
                          $ref: '#/components/schemas/TaskStatus'
                        tasks:
                          type: array
                          items:
                            $ref: '#/components/schemas/Task'
                        meta:
                          type: object
                          properties:
                            total:
                              type: integer

  /task-board/move:
    patch:
      summary: Move task on board
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [task_id, status_slug, index]
              properties:
                task_id:
                  type: integer
                status_slug:
                  type: string
                index:
                  type: integer
      responses:
        '200':
          description: Updated task
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Task'
        '422':
          description: Invalid move

  /reports/tasks/overview:
    get:
      summary: Task type overview metrics
      parameters:
        - in: query
          name: type_id
          required: true
          schema:
            type: integer
        - in: query
          name: range
          schema:
            type: string
            enum: ['7','30','90']
      responses:
        '200':
          description: Metrics for task type
          content:
            application/json:
              schema:
                type: object
                properties:
                  throughput:
                    type: array
                    items:
                      type: object
                      properties:
                        x:
                          type: string
                          format: date
                        y:
                          type: number
                  cycle_time:
                    type: array
                    items:
                      type: object
                      properties:
                        x:
                          type: string
                          format: date
                        y:
                          type: number
                  sla_attainment:
                    type: array
                    items:
                      type: object
                      properties:
                        x:
                          type: string
                          format: date
                        y:
                          type: number
components:
  schemas:
    Task:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        status:
          type: string
        status_color:
          type: string
          nullable: true
        scheduled_at:
          type: string
          format: date-time
        due_at:
          type: string
          format: date-time
          nullable: true
        priority:
          type: integer
          nullable: true
        assignee:
          $ref: '#/components/schemas/Employee'
        counts:
          type: object
          properties:
            comments:
              type: integer
            attachments:
              type: integer
            watchers:
              type: integer
            subtasks:
              type: integer
        sla_chip:
          type: string
          nullable: true
          enum:
            - ok
            - dueSoon
            - breached
        is_watching:
          type: boolean
    TaskComment:
      type: object
      properties:
        id:
          type: integer
        body:
          type: string
        user:
          $ref: '#/components/schemas/Employee'
        mentions:
          type: array
          items:
            $ref: '#/components/schemas/Employee'
        created_at:
          type: string
          format: date-time

    TaskSlaPolicy:
      type: object
      properties:
        id:
          type: integer
        priority:
          type: string
        response_within_mins:
          type: integer
          nullable: true
        resolve_within_mins:
          type: integer
          nullable: true
        calendar_json:
          type: object
          nullable: true
    TaskAutomation:
      type: object
      properties:
        id:
          type: integer
        task_type_id:
          type: integer
        event:
          type: string
        conditions_json:
          type: object
          nullable: true
        actions_json:
          type: array
          items:
            type: object
        enabled:
          type: boolean
    TaskSubtask:
      type: object
      properties:
        id:
          type: integer
        task_id:
          type: integer
        title:
          type: string
        is_completed:
          type: boolean
        assigned_user_id:
          type: integer
          nullable: true
        is_required:
          type: boolean
        position:
          type: integer
    Role:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
          nullable: true
        level:
          type: integer
    RoleAssignment:
      type: object
      required:
        - user_id
      properties:
        user_id:
          type: integer
        tenant_id:
          type: string
          nullable: true
    Team:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
          nullable: true
        employees:
          type: array
          items:
            $ref: '#/components/schemas/Employee'
    TaskType:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        schema_json:
          type: object
          nullable: true
          description: "Form schema. Text fields support string or {en,el} objects."
        statuses:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          nullable: true
        status_flow_json:
          type: object
          nullable: true
        tenant_id:
          type: integer
          nullable: true
        abilities_json:
          type: object
          nullable: true
    TaskStatus:
      type: object
      properties:
        id:
          type: integer
        slug:
          type: string
        name:
          type: string
        color:
          type: string
        position:
          type: integer
        tenant_id:
          type: integer
          nullable: true
    Employee:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
    Notification:
      type: object
      required:
        - id
        - message
        - created_at
      properties:
        id:
          type: integer
        message:
          type: string
        link:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        read_at:
          type: string
          format: date-time
          nullable: true
    ListMeta:
      type: object
      properties:
        total:
          type: integer
        per_page:
          type: integer
        current_page:
          type: integer
    Error:
      type: object
      required:
        - message
      properties:
        message:
          type: string
